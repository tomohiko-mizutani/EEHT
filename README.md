# EEHT: Efficient and Effective Implementation of Hottopixx Methods

This repository contains MATLAB code for the EEHT methods, introduced in the following paper:

*Endmember Extraction From Hyperspectral Images Using Self-Dictionary Approach With Linear Programming*, TSP, 2025.
 [https://doi.org/10.1109/TSP.2025.3624413](https://doi.org/10.1109/TSP.2025.3624413)

## Requirements

You need to install CPLEX.
This code has been tested with CPLEX version 22.1.2.

## Notes on Previous Versions

Previous version of this code used the MATLAB function `cplexlp.m`, which was included in CPLEX version 12.10.0.
However, CPLEX version 20.1 or later no longer provides this function.
Therefore, the current version provides a MEX file to interface with CPLEX.

## Build (MEX)

This code requires compiling the MEX file `cplexlp_mex.c`, which is located in `./eehtlib/mexfunc/`.

The provided makefiles are `makefile.linux` and `makefile.mac` for Linux and macOS, respectively.
These makefiles assume that CPLEX version 22.1.2 is installed and MATLAB R2024b is used.
You may need to edit them depending on your environment.

### macOS

Move to the directory and run the following command in the terminal:

```sh
make -f makefile.mac all
```

### Linux

Move to the directory and run the following command in the terminal:

```sh
make -f makefile.linux all
```

## Quick Start

You can find the MATLAB script `runEeht.m` in the `./scripts/` directory.
This script runs the EEHT methods (Algorithm 4) for a noisy separable matrix  $A = W H + N$ of size $d \times n$ with factorization rank $r$.

Start MATLAB, navigate to the `./scripts/` directory, and run the following command:

```matlab
setup
```

The `setup.m` script adds the required directory to the MATLAB path.
Then, run the following command:

```matlab
runEeht
```

The input and output of the `runEeht.m` script are as follows.

### Input

- `d` : Number of rows of $A$
- `n` : Number of columns of $A$
- `factorRank` : Factorization rank $r$ of $A$
- `nu` : Noise intensity level, i.e, $\nu = \lVert N \rVert_1$
- `seed` : Random seed

This input data corresponds to the normal-type matrix
described in Section 6 of the paper: *Refinement of Hottopixx Method for Nonnegative Matrix Factorization Under Noisy Separability*, SIMAX, 2022. <https://doi.org/10.1137/21M1442206>.

### Output

- Recovery rates, MRSA scores, and SAD scores for EEHT-A, EEHT-B, and EEHT-C
- Elapsed time

You can configure the EEHT parameters by setting the fields of the structure variable `opts`. See the next section for details.

## Parameters in the EEHT Methods

The EEHT parameters are specified through the structure variable `opts`.
It contains the following fields:

- `opts.displayFlag`: Set to `1` to enable output display, or `0` to disable it. The default value is `0`.
- `opts.zeta`: This parameter is used in the step of constructing the initial set $\mathcal{L}$. The default value depends on the number of columns $n$ of the input matrix $A$: if $n \le 300$, it is set to `0`; if $300 < n \le 50000$, it is set to `10`; and if $n \ge 50000$, it is set to `50`.
- `opts.eta`: This parameter is used in the step of constructing the initial set $\mathcal{L}$. The default value depends on the number of columns $n$ of the input matrix $A$: if $n \le 300$, it is set to `'all'`, which means that the parameter is set to the number of columns $n$; if $300 < n \le 50000$, it is set to `100`; and if $n \ge 50000$, it is set to `300`.
- `opts.zeroTol`: Tolerance for zero detection. The default value is `1.0e-6`.
- `opts.seedInitSet`: Random seed used to generate the set $\mathcal{L}_{\mathrm{EX}}$ in the step of constructing the initial set $\mathcal{L}$. The default value is `3887`.

For example, if you want to set `opts.zeta = 3` and `opts.eta = 50` when running the MATLAB script `runEeht.m`,
add the following lines to the script after `opts.displayFlag = 1;`:

```matlab
opts.zeta = 3;
opts.eta  = 50;
```

## Reproducing the Experiments

You can reproduce the experiments presented in the TSP paper using the MATLAB scripts in the `./scripts/` directory.
Before running the scripts, move to the directory and run the following command:

```matlab
setup
```

### 1. Endmember Extraction Performance Experiments

Section VI-B of the TSP paper presents endmember extraction performance experiments using datasets 1 and 2 (linear mixing models) and datasets 3 and 4 (bilinear mixing models). The experiments for datasets 1 and 2 can be reproduced using `runLmmExp.m`, and those for datasets 3 and 4 can be reproduced using `runBmmExp.m`.

The output files generated by these scripts are saved in the `./results/` directory.
You can plot the results using `runPlotLmmExpResults.m` for datasets 1 and 2, and `runPlotBmmExpResults.m` for datasets 3 and 4.

#### Example Commands

Run the experiments for datasets 1 and 2:

```matlab
runLmmExp
```

Plot the results for datasets 1 and 2:

```
runPlotLmmExpResults
```

### 2. Hyperspectral Unmixing Experiments

Section VI-C studies the unmixing of the Urban HSI dataset, assuming that there are six endmembers in the image: Asphalt, Grass, Tree, Roof 1, Roof 2, and Soil. Below is an RGB image of Urban.

<p align="center">
<img src="./data/real_data/urban.png" width="50%">
</p>

You can reproduce the experiments using `runUrbanUnmixingExp.m`.
The experiments use a preprocessing technique with parameters $\phi$ and $\omega$, as described in Section VI-C.
To run the script, you need to set the input argument `preprocOpt` according to the table below.

| `preprocOpt` | Parameters $(\phi,\omega)$ |
| --- | --- |
| 1   | $(0.4,0.1)$ |
| 2   | $(0.45,0.15)$ |
| 3   | $(0.5,0.3)$ |
| 4   | $(0.55,0.45)$ |
| 5   | $(0.6,0.6)$ |

The output files generated by the script are saved in the `./results/` directory.
You can plot the results for `preprocOpt = 1` using `runPlotUrbanUnmixingExpResults.m`.
If you want to plot the results for different values of `preprocOpt`, edit the script accordingly.

#### Example Commands

Run the experiments:

```matlab
runUrbanUnmixingExp
```

Plot the results:

```
runPlotUrbanUnmixingExpResults
```

### Remarks on the Accuracy Evaluation

The experiments in the TSP paper use the reference endmember signatures identified in the [arXiv paper](https://arxiv.org/abs/1708.05125) to evaluate the accuracy of the endmember signatures estimated by EEHT. This code uses alternative reference signatures for the evaluation, which are generated using the procedure described in Section 5.3 of the [arXiv paper](https://arxiv.org/abs/2512.10506).

As a result, the reference endmember signatures used in the TSP paper and in this code do not exactly match. However, the differences are negligible: the MRSA values between the corresponding signatures are below $10^{-5}$.

## Performance Dependencies

If the Hottopixx model has multiple optimal solutions, the endmember signatures estimated by EEHT may depend on the choice of LP solver and the CPLEX version.

The experiments presented in the TSP paper were conducted using the MATLAB function `cplexlp.m`, which was included in CPLEX version 12.10.0. When the current version of this code is run with CPLEX version 22.1.2 via a MEX file for the endmember extraction performance experiments, the results did not exactly match those obtained with the previous version of the code.

---
Contact: Tomohiko Mizutani [(mizutani.t@shizuoka.ac.jp)](mailto:mizutani.t@shizuoka.ac.jp)
